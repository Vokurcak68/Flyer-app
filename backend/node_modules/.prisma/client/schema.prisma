datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ========================================
// USERS & AUTHENTICATION
// ========================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  firstName    String?   @map("first_name")
  lastName     String?   @map("last_name")
  role         UserRole
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLogin    DateTime? @map("last_login")

  // Relations
  brands     UserBrand[]
  products   Product[]
  flyers     Flyer[]
  approvals  Approval[]
  userFlyers UserFlyer[]
  auditLogs  AuditLog[]

  @@map("users")
}

enum UserRole {
  admin
  supplier
  approver
  end_user
}

model UserBrand {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  brandId   String   @map("brand_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id])
  brand Brand @relation(fields: [brandId], references: [id])

  @@map("user_brands")
}

// ========================================
// BRANDS & PRODUCTS
// ========================================

model Brand {
  id           String   @id @default(uuid())
  name         String
  logoData     Bytes?   @map("logo_data")
  logoMimeType String?  @map("logo_mime_type")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  users       UserBrand[]
  products    Product[]
  promoImages PromoImage[]

  @@map("brands")
}

model Product {
  id            String   @id @default(uuid())
  supplierId    String   @map("supplier_id")
  brandId       String   @map("brand_id")
  eanCode       String   @unique @map("ean_code")
  name          String
  description   String?
  imageData     Bytes    @map("image_data")
  imageMimeType String   @map("image_mime_type")
  price         Decimal  @db.Decimal(10, 2)
  originalPrice Decimal? @map("original_price") @db.Decimal(10, 2)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  supplier User  @relation(fields: [supplierId], references: [id])
  brand    Brand @relation(fields: [brandId], references: [id])

  icons                 ProductIcon[]
  flyerPageSlots        FlyerPageSlot[]
  userFlyerPageProducts UserFlyerPageProduct[]

  @@index([eanCode])
  @@index([supplierId])
  @@index([brandId])
  @@map("products")
}

// Global icon library managed by admin
model Icon {
  id            String   @id @default(uuid())
  name          String
  imageData     Bytes    @map("image_data")
  imageMimeType String   @map("image_mime_type")
  isEnergyClass Boolean  @default(false) @map("is_energy_class") // Energy class icons are 2x wider
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  productIcons ProductIcon[]

  @@map("icons")
}

// Junction table for products and icons (up to 4 icons per product)
model ProductIcon {
  id        String @id @default(uuid())
  productId String @map("product_id")
  iconId    String @map("icon_id")
  position  Int // 0-3 (max 4 icons)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  icon    Icon    @relation(fields: [iconId], references: [id])

  @@unique([productId, position])
  @@map("product_icons")
}

// ========================================
// PROMO IMAGES
// ========================================

model PromoImage {
  id            String        @id @default(uuid())
  supplierId    String        @map("supplier_id")
  brandId       String?       @map("brand_id")
  name          String
  imageData     Bytes         @map("image_data")
  imageMimeType String        @map("image_mime_type")
  defaultSize   PromoSlotSize @default(single) @map("default_size")
  createdAt     DateTime      @default(now()) @map("created_at")

  brand          Brand?          @relation(fields: [brandId], references: [id])
  flyerPageSlots FlyerPageSlot[]
  footerPages    FlyerPage[]     @relation("PageFooter")

  @@map("promo_images")
}

// ========================================
// FLYERS
// ========================================

model Flyer {
  id                   String      @id @default(uuid())
  supplierId           String      @map("supplier_id")
  name                 String
  validFrom            DateTime?   @map("valid_from") @db.Date
  validTo              DateTime?   @map("valid_to") @db.Date
  status               FlyerStatus
  isDraft              Boolean     @default(true) @map("is_draft")
  rejectionReason      String?     @map("rejection_reason")
  pdfData              Bytes?      @map("pdf_data")
  pdfMimeType          String?     @map("pdf_mime_type")
  lastEditedAt         DateTime    @default(now()) @map("last_edited_at")
  autoSaveVersion      Int         @default(1) @map("auto_save_version")
  completionPercentage Int         @default(0) @map("completion_percentage")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")
  publishedAt          DateTime?   @map("published_at")

  supplier User @relation(fields: [supplierId], references: [id])

  pages            FlyerPage[]
  verificationLogs VerificationLog[]
  approvals        Approval[]
  approvalWorkflow ApprovalWorkflow?
  versions         FlyerVersion[]
  editHistory      FlyerEditHistory[]

  @@index([status])
  @@index([validFrom, validTo])
  @@index([supplierId])
  @@map("flyers")
}

enum FlyerStatus {
  draft
  pending_verification
  pending_approval
  approved
  rejected
  active
  expired
}

model FlyerPage {
  id                 String  @id @default(uuid())
  flyerId            String  @map("flyer_id")
  pageNumber         Int     @map("page_number")
  footerPromoImageId String? @map("footer_promo_image_id")

  flyer            Flyer           @relation(fields: [flyerId], references: [id], onDelete: Cascade)
  slots            FlyerPageSlot[]
  footerPromoImage PromoImage?     @relation("PageFooter", fields: [footerPromoImageId], references: [id])

  @@unique([flyerId, pageNumber])
  @@map("flyer_pages")
}

// Slot model - each page has 8 slots (2 columns x 4 rows)
// Slots can contain either a product or a promo image
// Promo images can span multiple slots
model FlyerPageSlot {
  id           String   @id @default(uuid())
  pageId       String   @map("page_id")
  slotPosition Int      @map("slot_position") // 0-7 (position in 2x4 grid)
  slotType     SlotType @map("slot_type")

  // For product slots
  productId String? @map("product_id")

  // For promo slots
  promoImageId  String?        @map("promo_image_id")
  promoSize     PromoSlotSize? @map("promo_size") // How many slots this promo spans
  isPromoAnchor Boolean        @default(false) @map("is_promo_anchor") // True for the first slot of multi-slot promo
  promoAnchorId String?        @map("promo_anchor_id") // Points to anchor slot if this is part of multi-slot promo

  page              FlyerPage       @relation(fields: [pageId], references: [id], onDelete: Cascade)
  product           Product?        @relation(fields: [productId], references: [id])
  promoImage        PromoImage?     @relation(fields: [promoImageId], references: [id])
  promoAnchor       FlyerPageSlot?  @relation("PromoSpan", fields: [promoAnchorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  promoSpannedSlots FlyerPageSlot[] @relation("PromoSpan")

  @@unique([pageId, slotPosition])
  @@map("flyer_page_slots")
}

enum SlotType {
  product
  promo
  empty
}

enum PromoSlotSize {
  single // 1 slot (1x1)
  horizontal // 2 slots horizontal (2x1)
  square // 4 slots (2x2)
  full_page // 8 slots (full page)
  footer // Footer (2cm height, full width) - only for page 1
}

// ========================================
// VERIFICATION & APPROVAL
// ========================================

model VerificationLog {
  id               String             @id @default(uuid())
  flyerId          String             @map("flyer_id")
  verificationDate DateTime           @map("verification_date")
  status           VerificationStatus
  details          Json
  createdAt        DateTime           @default(now()) @map("created_at")

  flyer Flyer @relation(fields: [flyerId], references: [id])

  @@map("verification_logs")
}

enum VerificationStatus {
  success
  failed
}

model Approval {
  id         String         @id @default(uuid())
  flyerId    String         @map("flyer_id")
  approverId String         @map("approver_id")
  status     ApprovalStatus
  comment    String?
  decidedAt  DateTime?      @map("decided_at")
  createdAt  DateTime       @default(now()) @map("created_at")

  flyer    Flyer @relation(fields: [flyerId], references: [id])
  approver User  @relation(fields: [approverId], references: [id])

  @@unique([flyerId, approverId])
  @@index([flyerId, status])
  @@map("approvals")
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

model ApprovalWorkflow {
  id                String   @id @default(uuid())
  flyerId           String   @unique @map("flyer_id")
  requiredApprovers Int      @default(2) @map("required_approvers")
  currentApprovals  Int      @default(0) @map("current_approvals")
  isComplete        Boolean  @default(false) @map("is_complete")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  flyer Flyer @relation(fields: [flyerId], references: [id])

  @@map("approval_workflow")
}

// ========================================
// VERSIONING & HISTORY
// ========================================

model FlyerVersion {
  id                String   @id @default(uuid())
  flyerId           String   @map("flyer_id")
  versionNumber     Int      @map("version_number")
  snapshotData      Json     @map("snapshot_data")
  createdBy         String   @map("created_by")
  changeDescription String?  @map("change_description")
  createdAt         DateTime @default(now()) @map("created_at")

  flyer Flyer @relation(fields: [flyerId], references: [id], onDelete: Cascade)

  @@unique([flyerId, versionNumber])
  @@index([flyerId, createdAt])
  @@map("flyer_versions")
}

model FlyerEditHistory {
  id         String          @id @default(uuid())
  flyerId    String          @map("flyer_id")
  userId     String          @map("user_id")
  actionType FlyerActionType @map("action_type")
  details    Json?
  createdAt  DateTime        @default(now()) @map("created_at")

  flyer Flyer @relation(fields: [flyerId], references: [id], onDelete: Cascade)

  @@index([flyerId, createdAt])
  @@map("flyer_edit_history")
}

enum FlyerActionType {
  add_product
  remove_product
  add_page
  remove_page
  update_info
  reorder
}

// ========================================
// END USER FLYERS
// ========================================

model UserFlyer {
  id                   String   @id @default(uuid())
  userId               String   @map("user_id")
  name                 String
  isDraft              Boolean  @default(true) @map("is_draft")
  lastEditedAt         DateTime @default(now()) @map("last_edited_at")
  completionPercentage Int      @default(0) @map("completion_percentage")
  pdfData              Bytes?   @map("pdf_data")
  pdfMimeType          String?  @map("pdf_mime_type")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  user  User            @relation(fields: [userId], references: [id])
  pages UserFlyerPage[]

  @@index([userId])
  @@map("user_flyers")
}

model UserFlyerPage {
  id          String @id @default(uuid())
  userFlyerId String @map("user_flyer_id")
  pageNumber  Int    @map("page_number")

  userFlyer UserFlyer              @relation(fields: [userFlyerId], references: [id], onDelete: Cascade)
  products  UserFlyerPageProduct[]

  @@unique([userFlyerId, pageNumber])
  @@map("user_flyer_pages")
}

model UserFlyerPageProduct {
  id        String @id @default(uuid())
  pageId    String @map("page_id")
  productId String @map("product_id")
  position  Int

  page    UserFlyerPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  product Product       @relation(fields: [productId], references: [id])

  @@unique([pageId, position])
  @@map("user_flyer_page_products")
}

// ========================================
// AUDIT LOG
// ========================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  changes    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId, action])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
